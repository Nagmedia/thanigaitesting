import{a as H,b as M,d as P}from"https://app.framerstatic.com/chunk-YEY55H4N.mjs";import{F as y,K as C,L,M as b,O as k,P as w,Q as U}from"https://app.framerstatic.com/chunk-A7BTCLC7.mjs";import{b as u}from"https://app.framerstatic.com/chunk-VME2HSKU.mjs";import{a as T}from"https://app.framerstatic.com/chunk-QCBYQTL3.mjs";import{b as I}from"https://app.framerstatic.com/chunk-XCL4UJVK.mjs";import{o as l}from"https://app.framerstatic.com/chunk-2GTAWJRW.mjs";import{f as D}from"https://app.framerstatic.com/chunk-RZLQRIKM.mjs";import{l as R}from"https://app.framerstatic.com/chunk-QIXHNEYN.mjs";import{a as S}from"https://app.framerstatic.com/chunk-EVPQFP72.mjs";import{l as f,v as h}from"https://app.framerstatic.com/chunk-L6RIH4MY.mjs";import{a}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{a as g}from"https://app.framerstatic.com/chunk-LQILWJHN.mjs";import{j as s}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";var m=h("RemoteConnection"),E=1e3,p=class extends u{constructor(e){super();s(this,"isReconnect",!1);s(this,"messageQueue",[]);s(this,"baseURL");s(this,"socket");s(this,"stats");this.baseURL=P(e)}createPingInterval(e,n){return setInterval(()=>{if(a(this.socket===e,"Invalid socket"),a(this.stats===n,"Invalid stats"),performance.now()-n.lastSend()<E||n.pendingCount("ping")>0)return;let t="ping {}";e.send(t),n.sent("ping",t)},E)}connect(e){if(this.socket)return;let n=new URL(this.baseURL);n.searchParams.set("v",String(L)),n.searchParams.set("tunnel",S()??""),n.searchParams.set("treeSchema",String(l)),n.searchParams.set("treeVersion",String(e));let t=new WebSocket(n),r=new C;this.socket=t,this.stats=r,m.debug("Connecting:",t.url);let o;t.addEventListener("open",()=>{a(this.socket===t,"Invalid socket"),a(this.stats===r,"Invalid stats"),m.debug("Connected:",t.url),o=this.createPingInterval(t,r),this.emit("connect",this.isReconnect),this.isReconnect=!0,this.flushMessageQueue(t,r)}),t.addEventListener("message",i=>{a(this.socket===t,"Invalid socket"),a(this.stats===r,"Invalid stats");let c=i.data,d=w(c);if(r.received(c),d.type==="ack")return r.acked();d.type==="redirect"&&(this.baseURL=d.value.url),m.trace("Received:",d),this.emit("message",d)}),t.addEventListener("close",i=>{a(this.socket===t,"Invalid socket"),a(this.stats===r,"Invalid stats"),clearInterval(o);let c=k(i);m.debug("Disconnected:",c),this.socket=void 0,this.stats=void 0,this.emit("disconnect",c)})}disconnect(){this.socket?.close()}flushMessageQueue(e,n){if(e.readyState===WebSocket.OPEN){for(let{type:t,value:r}of this.messageQueue)try{let o=JSON.stringify(r),i=`${t} ${o}`;e.send(i),n.sent(t,i)}catch(o){m.warn("Error sending:",t,o)}this.messageQueue.length=0}}send(e){this.messageQueue.push(e),this.socket&&this.stats&&this.flushMessageQueue(this.socket,this.stats)}sendMessage(e){this.send(e)}onMessage(e){return this.on("message",e),()=>{this.off("message",e)}}};var A=h("remote:project"),V=100,j=class extends u{constructor(e,n,t,r){super();this.timeline=e;this.userId=n;this.projectId=t;this.abortSignal=r;s(this,"connection");s(this,"treeDataHandler");s(this,"api");s(this,"modulesAPI");s(this,"assetService");s(this,"reconnectTimeout");s(this,"documentLoader");s(this,"shouldReconnect",!0);s(this,"postponedLastUpdate");s(this,"handleError",e=>{A.warn("Permanent error:",e),this.emit("disconnect","ClientSidePermanentError")});s(this,"handleRecoverableError",()=>{this.emit("disconnect","ClientSidePermanentError")});s(this,"handleUpdateProcessed",e=>{this.emit("update",e)});this.connection=new p(this.projectId),this.api=new M(this.connection,this.projectId),this.assetService=new R(this.api),this.modulesAPI=new H(this.api,this.connection),this.connection.on("disconnect",this.onDisconnect,this),this.connection.on("message",this.onMessage,this),this.assetService.refresh().catch(f),r?.addEventListener("abort",()=>this.disconnect(),{once:!0})}createDataHandler(){let e={error:this.handleError,errorRecoverable:this.handleRecoverableError,updateProcessed:this.handleUpdateProcessed};return T()?new y(this.timeline,this.userId,this.projectId,e):new U(this.timeline,this.projectId,e)}connect(){let e=this.treeDataHandler?.treeVersion??0;this.connection.connect(e),this.timeline.setOnline(!0),this.shouldReconnect=!0}disconnect(){this.shouldReconnect=!1,this.cancelReconnect(),this.connection.disconnect(),this.timeline.setOnline(!1)}maybeSend(){this.postponedLastUpdate&&(clearTimeout(this.postponedLastUpdate),this.postponedLastUpdate=void 0);let e=this.treeDataHandler?.maybeSend(this.connection)??"postpone";e==="postpone"&&(this.postponedLastUpdate=setTimeout(()=>this.maybeSend(),V)),e==="didSend"&&D("editor_bar_interaction",{page:"editor-bar-project-page",id:"editor-bar-tree-update"})}cancelReconnect(){clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0}scheduleReconnect(e){this.cancelReconnect(),this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this.connect()},e)}onDisconnect(e){if(this.treeDataHandler=void 0,this.shouldReconnect||A.warn("Disconnect:",e),this.shouldReconnect&&b(e)){let n=O(e);this.scheduleReconnect(n)}}onMessage(e){switch(e.type){case"treeMessage":return this.handleTreeMessage(e.value);case"treeUpdate":return this.handleTreeUpdate(e.value);case"rows":return this.handleRows(e.id,e.value);case"confirmRows":return this.handleConfirmRows(e.value.seq);case"notifyProjectChange":switch(e.value.waitForRestart&&I({icon:"reconnecting",duration:1/0,showCloseButton:"never",type:"add",variant:"progress",text:"Waiting for project restart after canvas features changed"}),e.value.scope){case"assets":return this.assetService.refresh();case"assetsInvalidated":return this.assetService.refreshFully();default:return}}}handleTreeMessage(e){if(e.type!=="init")return;let n=g(),t=new URL(e.data.file,n.app);this.treeDataHandler||(this.treeDataHandler=this.createDataHandler()),this.treeDataHandler.handleInit(e.data.treeVersion,e.data.initialUpdates).needsDownload&&this.downloadDocument(t.href,e.data.treeVersion)}handleTreeUpdate(e){a(this.treeDataHandler,"Cannot handle remote updates before init"),this.treeDataHandler.handleTreeUpdate(e),this.treeDataHandler.processRemoteUpdates()}handleRows(e,n){a(this.treeDataHandler,"Cannot handle remote updates before init"),this.treeDataHandler.handleRows(e,n),this.treeDataHandler.processRemoteUpdates()}handleConfirmRows(e){a(this.treeDataHandler,"Cannot handle remote updates before init"),this.treeDataHandler.handleConfirmRows(e),this.treeDataHandler.processRemoteUpdates()}downloadDocument(e,n){let t=this.treeDataHandler;a(t?.waitingForTree,"Must be waiting for tree"),this.documentLoader&&(this.documentLoader.scheduler.cancel(),this.documentLoader.removeAllListeners());let r={partialParsing:!0,loadInBackground:!0,async refreshAccessToken(i){return{...i,credentials:"include"}}},o=t.createLoader(e,n,r);this.documentLoader=o,o.on("loadedFirstData",i=>{i.setService("metadata",{projectId:this.projectId}),o.pauseLoadingScopes();let c={isLoading:!0};t.setTree(i,n,c),t.processRemoteUpdates(),o.canvasTreeVersion<l&&this.emit("disconnect","ClientTooNew"),o.canvasTreeVersion>l&&this.emit("disconnect","ClientNeedsUpdate")}),o.on("loadedAllData",()=>{t.loadedAllScopes(),this.emit("update",this.timeline.tree)}),o.on("loadedScope",i=>{t.loadOneScope(i,!1),this.emit("update",this.timeline.tree)}),o.start().catch(f)}};function O(v){return v==="ReconnectToNewServer"?25:1e3}export{j as a};
//# sourceMappingURL=https://app.framerstatic.com/chunk-D457OI37.mjs.map
